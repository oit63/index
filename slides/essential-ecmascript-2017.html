<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN"
"http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd">
<!--[if lt IE 7]> <html class='no-js ie6' lang='en' xmlns='http://www.w3.org/1999/xhtml'> <![endif]-->
<!--[if IE 7]> <html class='no-js ie7' lang='en' xmlns='http://www.w3.org/1999/xhtml'> <![endif]-->
<!--[if IE 8]> <html class='no-js ie8' lang='en' xmlns='http://www.w3.org/1999/xhtml'> <![endif]-->
<!--[if gt IE 8]><!--> <html  lang='en' xmlns='http://www.w3.org/1999/xhtml'> <!--<![endif]-->
<head>
<title>Essential EcmaScript 2017</title>
<meta http-equiv='Content-Type' content='text/html; charset=utf-8'/>
<meta name='generator' content='Org-mode'/>
<meta name='author' content='<a href="https://oyanglul.us/">欧阳继超</a>'/>

<link rel='stylesheet' href='https://blog.oyanglul.us/deck.js/core/deck.core.css' type='text/css' />
<link rel='stylesheet' href='https://blog.oyanglul.us/deck.js/extensions/goto/deck.goto.css' type='text/css' />
<link rel='stylesheet' href='https://blog.oyanglul.us/deck.js/extensions/menu/deck.menu.css' type='text/css' />
<link rel='stylesheet' href='https://blog.oyanglul.us/deck.js/extensions/navigation/deck.navigation.css' type='text/css' />
<link rel='stylesheet' href='https://blog.oyanglul.us/deck.js/extensions/scale/deck.scale.css' type='text/css' />
<link rel='stylesheet' href='https://blog.oyanglul.us/deck.js/extensions/status/deck.status.css' type='text/css' />
<link rel='stylesheet' href='https://blog.oyanglul.us/deck.js/themes/style/web-2.0.css' type='text/css' />
<link rel='stylesheet' href='https://blog.oyanglul.us/deck.js/themes/transition/horizontal-slide.css' type='text/css' />
<script src='https://blog.oyanglul.us/deck.js/jquery.min.js' type='text/javascript'></script>
<script src='https://blog.oyanglul.us/deck.js/core/deck.core.js' type='text/javascript'></script>
<script src='https://blog.oyanglul.us/deck.js/modernizr.custom.js' type='text/javascript'></script>
<script src='https://blog.oyanglul.us/deck.js/extensions/goto/deck.goto.js' type='text/javascript'></script>
<script src='https://blog.oyanglul.us/deck.js/extensions/menu/deck.menu.js' type='text/javascript'></script>
<script src='https://blog.oyanglul.us/deck.js/extensions/navigation/deck.navigation.js' type='text/javascript'></script>
<script src='https://blog.oyanglul.us/deck.js/extensions/scale/deck.scale.js' type='text/javascript'></script>
<script src='https://blog.oyanglul.us/deck.js/extensions/status/deck.status.js' type='text/javascript'></script>

<script type='text/javascript'>
  $(document).ready(function () { $.deck('.slide'); });
</script>

<style type='text/css'>
#table-of-contents a {color: inherit;}
#table-of-contents ul {margin-bottom: 0;}
#table-of-contents li {padding: 0;}

#preamble, #postamble {left: 5px; width: 100%;}
#preamble {position: absolute; top: 10px;}
#postamble {}

#title-slide h1 {
    position: static; padding: 0;
    margin-top: 10%;
    -webkit-transform: none;
    -moz-transform: none;
    -ms-transform: none;
    -o-transform: none;
    transform: none;
}
#title-slide h2 {
    text-align: center;
    border:none;
    padding: 0;
    margin: 0;
}
</style>
</head>
<body>
<div id='content' class='deck-container'>

<div id='title-slide' class='slide'>
<h1>Essential EcmaScript 2017</h1>
<h2></h2>
<h2><a href="https://oyanglul.us/">欧阳继超</a></h2>
<h2><a href="mailto:oyanglulu@gmail.com">oyanglulu@gmail.com</a></h2>
<h2></h2>
</div>
<div id='table-of-contents' class='slide'>
<h2>Table of Contents</h2>

<ul>
<li><a href='#outline-container-sec-'>Overview</a></li>
<li><a href='#outline-container-sec-'></a></li>
<li><a href='#outline-container-sec-'>glossary (强行科普)</a>
<ul>
<li>tc39</li>
<li>ecma-262</li>
<li>stage</li>
</ul>
</li>
<li><a href='#outline-container-sec-'>Fun Facts</a></li>
<li><a href='#outline-container-sec-'>ES7 (EcmaScript 2016)</a>
<ul>
<li>Array.prototype.includes</li>
<li>Exponentiation Operator</li>
</ul>
</li>
<li><a href='#outline-container-sec-'>ES8 (EcmaScript 2017)</a></li>
<li><a href='#outline-container-sec-'>Object.values</a></li>
<li><a href='#outline-container-sec-'>Object.entries</a></li>
<li><a href='#outline-container-sec-'>String padding</a></li>
<li><a href='#outline-container-sec-'>有了ES2017，麻麻再也不用担心Leftpad作者生气了</a>
<ul>
<li>String.prototype.padStart</li>
<li>String.prototype.padEnd</li>
</ul>
</li>
<li><a href='#outline-container-sec-'>Object.getOwnPropertyDescriptors</a>
<ul>
<li>现在继承可以这么简单的写</li>
<li>shallow clone</li>
</ul>
</li>
<li><a href='#outline-container-sec-'>Trailing commas in function parameter lists and calls</a></li>
<li><a href='#outline-container-sec-'>Async Functions</a></li>
<li><a href='#outline-container-sec-'></a>
<ul>
<li>Promise</li>
</ul>
</li>
<li><a href='#outline-container-sec-'></a>
<ul>
<li>generator</li>
</ul>
</li>
<li><a href='#outline-container-sec-'></a>
<ul>
<li>但是promise只会把callback hell，改成 then hell</li>
</ul>
</li>
<li><a href='#outline-container-sec-'></a>
<ul>
<li>虽然这种情况可以用 Promise.all 来解决</li>
</ul>
</li>
<li><a href='#outline-container-sec-'></a>
<ul>
<li></li>
</ul>
</li>
<li><a href='#outline-container-sec-'></a>
<ul>
<li>coroutine</li>
</ul>
</li>
<li><a href='#outline-container-sec-'></a>
<ul>
<li>最重要的是，还可以命令式的 try catch</li>
</ul>
</li>
<li><a href='#outline-container-sec-'></a>
<ul>
<li>现在有了 async function，不再需要第三方库的支持</li>
</ul>
</li>
<li><a href='#outline-container-sec-'></a>
<ul>
<li>但是不用太激动</li>
</ul>
</li>
<li><a href='#outline-container-sec-'>而spawn的实现也很简单</a>
<ul>
<li>返回一个 Promise</li>
</ul>
</li>
<li><a href='#outline-container-sec-'></a>
<ul>
<li>call the generator function <code>genF</code></li>
</ul>
</li>
<li><a href='#outline-container-sec-'></a>
<ul>
<li>异步的递归step</li>
</ul>
</li>
<li><a href='#outline-container-sec-'></a>
<ul>
<li>resolve or reject promise</li>
</ul>
</li>
<li><a href='#outline-container-sec-'>Refs</a></li>
</ul>
</div>


<div id="outline-container-orgheadline1" class="outline-2  slide">
<h2 id="orgheadline1">Overview</h2>
<div class="outline-text-2" id="text-orgheadline1">
<p>
大部分浏览器都已经实现 90%+ 的 ES6 features 了，如果现在还在看 <a href="https://book.douban.com/subject/25966265/">ES6入门</a> 
我呵呵了。若是想快速回顾，不妨看看 <a href="https://blog.oyanglul.us/javascript/essential-ecmascript6.html">Essential EcmaScript 6</a>.
</p>

<p>
下面我们来看看 <a href="https://tc39.github.io/ecma262/">2017 草稿</a>中到底有些什么新黑科技：
</p>

<ul class="org-ul">
<li>Object.values/Object.entries</li>
<li>String padding</li>
<li>Object.getOwnPropertyDescriptors</li>
<li>Trailing commas in function parameter lists and calls</li>
<li>Async Functions</li>
</ul>
</div>
</div>
<div id="outline-container-orgheadline2" class="outline-2  slide">
<h2 id="orgheadline2"></h2>
<div class="outline-text-2" id="text-orgheadline2">
<p>
如果要问这些 proposals 都是哪来的，其实都可以在 tc39 的 <a href="https://github.com/tc39/proposals/blob/master/finished-proposals.md">这个</a> 页面找到
</p>


<div class="figure">
<p><img src="https://www.evernote.com/l/ABerDMRM9gJPdLeEzoX6JA5cVLfVoUffPWcB/image.png" alt="image.png" />
</p>
</div>

<p>
能到达这个页面的都是 stage 4 的 proposals
</p>

<p>
而到达 stage 4 的，就会出现在 draft 上 <a href="https://tc39.github.io/ecma262/">https://tc39.github.io/ecma262/</a>
</p>
</div>
</div>

<div id="outline-container-orgheadline6" class="outline-2  slide">
<h2 id="orgheadline6">glossary (强行科普)</h2>
<div class="outline-text-2" id="text-orgheadline6">
</div><div id="outline-container-orgheadline3" class="outline-3">
<h3 id="orgheadline3"><a href="http://www.ecma-international.org/memento/TCs&amp;TGs.htm">tc39</a></h3>
<div class="outline-text-3" id="text-orgheadline3">
<p>
Technical Committees 39
</p>
</div>
</div>
<div id="outline-container-orgheadline4" class="outline-3">
<h3 id="orgheadline4"><a href="http://www.ecma-international.org/publications/standards/Standard.htm">ecma-262</a></h3>
<div class="outline-text-3" id="text-orgheadline4">
<p>
ecma 262 号规范
</p>
</div>
</div>
<div id="outline-container-orgheadline5" class="outline-3">
<h3 id="orgheadline5"><a href="https://tc39.github.io/process-document/">stage</a></h3>
<div class="outline-text-3" id="text-orgheadline5">
<ul class="org-ul">
<li>0 strawman</li>
<li>1 proposal</li>
<li>2 draft</li>
<li>3 candidate</li>
<li>4 finished</li>
</ul>
</div>
</div>
</div>
<div id="outline-container-orgheadline7" class="outline-2  slide">
<h2 id="orgheadline7">Fun Facts</h2>
<div class="outline-text-2" id="text-orgheadline7">

<div class="figure">
<p><img src="https://blog.oyanglul.us/images/busted.gif" alt="busted.gif" />
</p>
</div>
<blockquote>
<p>
有人知道 ECMA-334 和 408 分别是什么语言的规范吗？
</p>
</blockquote>
</div>
</div>

<div id="outline-container-orgheadline8" class="outline-2  slide">
<h2 id="orgheadline8">ES7 (EcmaScript 2016)</h2>
<div class="outline-text-2" id="text-orgheadline8">
<p>
年份和版本号不要搞混了，7是指第七个版本，2016是release的年份，就像 ES6 也叫 ES2015 一样
</p>

<p>
ES7 很少被提及，是因为它的 feature 太少了，而且 <del>没什么卵用</del>
</p>
</div>

<div id="outline-container-orgheadline9" class="outline-3">
<h3 id="orgheadline9"><a href="https://github.com/tc39/Array.prototype.includes/">Array.prototype.includes</a></h3>
<div class="outline-text-3" id="text-orgheadline9">
<p>
这个没什么好说的，跟lodash的 <code>_.includes</code> 一样一样的
</p>

<p>
终于从语言层面上让 <code>indexOf &gt; -1</code> 更语义化了些。
</p>
</div>
</div>

<div id="outline-container-orgheadline10" class="outline-3">
<h3 id="orgheadline10"><a href="https://github.com/rwaldron/exponentiation-operator">Exponentiation Operator</a></h3>
<div class="outline-text-3" id="text-orgheadline10">
<p>
幂操作符, 这个应该是从 python 抄来的
</p>
<div class="org-src-container">

<pre class="src src-js">2**3 === 8
</pre>
</div>

<p>
<a href="http://babeljs.io/repl/#?babili=false&amp;evaluate=true&amp;lineWrap=false&amp;presets=latest%2Creact%2Cstage-2&amp;experimental=false&amp;loose=false&amp;spec=false&amp;code=2**3&amp;playground=true">babel的实现是简单的语法糖到</a> <code>Math.pow</code>
</p>
</div>
</div>
</div>

<div id="outline-container-orgheadline11" class="outline-2  slide">
<h2 id="orgheadline11">ES8 (EcmaScript 2017)</h2>
<div class="outline-text-2" id="text-orgheadline11">
<p>
下面来看看激动人心的ES8，先来看前面几个 <del>没什么卵用</del> 的小改动
</p>


<div class="figure">
<p><img src="https://blog.oyanglul.us/images/0day-accident.gif" alt="0day-accident.gif" />
</p>
</div>
</div>
</div>

<div id="outline-container-orgheadline12" class="outline-2  slide">
<h2 id="orgheadline12">Object.values</h2>
<div class="outline-text-2" id="text-orgheadline12">
<div class="org-src-container">

<pre class="src src-js"><span style="color: #00008b;">var</span> <span style="color: #b8860b;">obj</span> = { foo: <span style="color: #8b0000;">"bar"</span>, baz: 42 };
<span style="color: #00008b;">var</span> <span style="color: #b8860b;">array</span> = [1,2,3]
<span style="color: #00008b;">var</span> <span style="color: #b8860b;">symbol</span> = Symbol(<span style="color: #8b0000;">'abc'</span>)
<span style="color: #00008b;">var</span> <span style="color: #b8860b;">fn</span> = <span style="color: #00008b;">function</span>(){ <span style="color: #00008b;">return</span> {foo: <span style="color: #8b0000;">'bar'</span>} }
fn.baz = 42;
<span style="color: #00008b;">var</span> <span style="color: #b8860b;">string</span> = <span style="color: #8b0000;">'foobar'</span>
<span style="color: #00008b;">var</span> <span style="color: #b8860b;">number</span> = 123
console.log(Object.values(obj));
console.log(Object.values(array));
console.log(Object.values(symbol));
console.log(Object.values(string));
console.log(Object.values(number));
console.log(Object.values(fn));
console.log(Object.values(<span style="color: #6b8e23;">true</span>));
</pre>
</div>

<pre class="example">
[ 'bar', 42 ]
[ 1, 2, 3 ]
[]
[ 'f', 'o', 'o', 'b', 'a', 'r' ]
[]
[ 42 ]
[]
</pre>
</div>
</div>

<div id="outline-container-orgheadline13" class="outline-2  slide">
<h2 id="orgheadline13">Object.entries</h2>
<div class="outline-text-2" id="text-orgheadline13">
<div class="org-src-container">

<pre class="src src-js"><span style="color: #00008b;">var</span> <span style="color: #b8860b;">obj</span> = { foo: <span style="color: #8b0000;">"bar"</span>, baz: 42 };
<span style="color: #00008b;">var</span> <span style="color: #b8860b;">array</span> = [1,2,3]
<span style="color: #00008b;">var</span> <span style="color: #b8860b;">symbol</span> = Symbol(<span style="color: #8b0000;">'abc'</span>)
<span style="color: #00008b;">var</span> <span style="color: #b8860b;">fn</span> = <span style="color: #00008b;">function</span>(){ <span style="color: #00008b;">return</span> {foo: <span style="color: #8b0000;">'bar'</span>} }
fn.baz = 42;
<span style="color: #00008b;">var</span> <span style="color: #b8860b;">string</span> = <span style="color: #8b0000;">'foobar'</span>
<span style="color: #00008b;">var</span> <span style="color: #b8860b;">number</span> = 123
console.log(Object.entries(obj));
console.log(Object.entries(array));
console.log(Object.entries(symbol));
console.log(Object.entries(string));
console.log(Object.entries(number));
console.log(Object.entries(fn));
console.log(Object.entries(<span style="color: #6b8e23;">true</span>));
</pre>
</div>

<pre class="example">
[ [ 'foo', 'bar' ], [ 'baz', 42 ] ]
[ [ '0', 1 ], [ '1', 2 ], [ '2', 3 ] ]
[]
[ [ '0', 'f' ],
  [ '1', 'o' ],
  [ '2', 'o' ],
  [ '3', 'b' ],
  [ '4', 'a' ],
  [ '5', 'r' ] ]
[]
[ [ 'baz', 42 ] ]
[]
</pre>
</div>
</div>

<div id="outline-container-orgheadline14" class="outline-2  slide">
<h2 id="orgheadline14">String padding</h2>
<div class="outline-text-2" id="text-orgheadline14">
<p>
还记得 leftpad 吗？
<img src="https://edgeatx.github.io/slides/2016/03-mar/images/left-pad-npm.png" alt="left-pad-npm.png" />
</p>
</div>
</div>

<div id="outline-container-orgheadline17" class="outline-2  slide">
<h2 id="orgheadline17">有了ES2017，麻麻再也不用担心Leftpad作者生气了</h2>
<div class="outline-text-2" id="text-orgheadline17">
</div><div id="outline-container-orgheadline15" class="outline-3">
<h3 id="orgheadline15">String.prototype.padStart</h3>
<div class="outline-text-3" id="text-orgheadline15">
<div class="org-src-container">

<pre class="src src-js"><span style="color: #8b0000;">'abc'</span>.padStart(10);         <span style="color: #8c8c8c; font-style: italic;">// </span><span style="color: #8c8c8c; font-style: italic;">"       abc"</span>
<span style="color: #8b0000;">'abc'</span>.padStart(10, <span style="color: #8b0000;">"foo"</span>);  <span style="color: #8c8c8c; font-style: italic;">// </span><span style="color: #8c8c8c; font-style: italic;">"foofoofabc"</span>
</pre>
</div>
</div>
</div>

<div id="outline-container-orgheadline16" class="outline-3">
<h3 id="orgheadline16">String.prototype.padEnd</h3>
<div class="outline-text-3" id="text-orgheadline16">
<div class="org-src-container">

<pre class="src src-js"><span style="color: #8b0000;">'abc'</span>.padEnd(10);         <span style="color: #8c8c8c; font-style: italic;">// </span><span style="color: #8c8c8c; font-style: italic;">"abc       "</span>
<span style="color: #8b0000;">'abc'</span>.padEnd(10, <span style="color: #8b0000;">"foo"</span>);  <span style="color: #8c8c8c; font-style: italic;">// </span><span style="color: #8c8c8c; font-style: italic;">"abcfoofoof"</span>
</pre>
</div>
</div>
</div>
</div>


<div id="outline-container-orgheadline18" class="outline-2  slide">
<h2 id="orgheadline18"><a href="https://github.com/tc39/proposal-object-getownpropertydescriptors">Object.getOwnPropertyDescriptors</a></h2>
<div class="outline-text-2" id="text-orgheadline18">
<p>
<code>Object.getOwnPropertyDescriptor</code> 的复数形式
</p>
</div>

<div id="outline-container-orgheadline19" class="outline-3">
<h3 id="orgheadline19">现在继承可以这么简单的写</h3>
<div class="outline-text-3" id="text-orgheadline19">
<div class="org-src-container">

<pre class="src src-js"><span style="color: #00008b;">function</span> <span style="color: #6a5acd;">superclass</span>() {}
<span style="color: #00008b;">function</span> <span style="color: #6a5acd;">subclass</span>() {}
subclass.<span style="color: #6b8e23;">prototype</span> = Object.create(superclass.<span style="color: #6b8e23;">prototype</span>, Object.getOwnPropertyDescriptors({
    <span style="color: #8c8c8c; font-style: italic;">// </span><span style="color: #8c8c8c; font-style: italic;">define your methods and properties here</span>
}));
</pre>
</div>
</div>
</div>

<div id="outline-container-orgheadline20" class="outline-3">
<h3 id="orgheadline20">shallow clone</h3>
<div class="outline-text-3" id="text-orgheadline20">
<div class="org-src-container">

<pre class="src src-js"><span style="color: #00008b;">const</span> <span style="color: #b8860b;">shallowClone</span> = (object) =&gt; Object.create(
  Object.getPrototypeOf(object),
  Object.getOwnPropertyDescriptors(object)
);
</pre>
</div>
</div>
</div>
</div>


<div id="outline-container-orgheadline21" class="outline-2  slide">
<h2 id="orgheadline21">Trailing commas in function parameter lists and calls</h2>
<div class="outline-text-2" id="text-orgheadline21">
<p>
这个东西没什么用，跟数组一样，只有code diff的时候
</p>
<div class="org-src-container">

<pre class="src src-diff">  1: function clownPuppiesEverywhere(
  2:   param1,
  3:   param2,
+ 4:   param3,  // updated to add new parameter
  5: ) { /* ... */ }
</pre>
</div>
<p>
才有那么一丢丢用
</p>
</div>
</div>

<div id="outline-container-orgheadline22" class="outline-2  slide">
<h2 id="orgheadline22">Async Functions</h2>
<div class="outline-text-2" id="text-orgheadline22">
<p>
终于到 <code>async function</code> 了，但是在开始之前，我们来回顾一下 ES6 的 Promise 和 generator
</p>


<div class="figure">
<p><img src="https://blog.oyanglul.us/images/nibbler-eat-chickens.gif" alt="nibbler-eat-chickens.gif" />
</p>
</div>
</div>
</div>

<div id="outline-container-orgheadline24" class="outline-2  slide">
<h2 id="orgheadline24"></h2>
<div class="outline-text-2" id="text-orgheadline24">
</div><div id="outline-container-orgheadline23" class="outline-3">
<h3 id="orgheadline23">Promise</h3>
<div class="outline-text-3" id="text-orgheadline23">
<div class="org-src-container">

<pre class="src src-js"><span style="color: #00008b;">new</span> <span style="color: #36648b;">Promise</span>((resolve, reject) =&gt; {
    console.log(<span style="color: #8b0000;">'first'</span>)
    setTimeout(resolve, 1000);
}).then(() =&gt; {
    console.log(<span style="color: #8b0000;">'next 1s'</span>)
    <span style="color: #00008b;">throw</span> <span style="color: #00008b;">new</span> <span style="color: #36648b;">Error</span>(<span style="color: #8b0000;">"hmm"</span>);
}).<span style="color: #00008b;">catch</span>(err =&gt; {
    console.log(<span style="color: #8b0000;">'error:'</span>+err)
})
</pre>
</div>

<pre class="example">
first
next 1s
error:Error: hmm
</pre>
</div>
</div>
</div>

<div id="outline-container-orgheadline26" class="outline-2  slide">
<h2 id="orgheadline26"></h2>
<div class="outline-text-2" id="text-orgheadline26">
</div><div id="outline-container-orgheadline25" class="outline-3">
<h3 id="orgheadline25">generator</h3>
<div class="outline-text-3" id="text-orgheadline25">
<p>
现代浏览器都已经支持 generator 了, 写一个fibonacci数列生成器
</p>
<div class="org-src-container">

<pre class="src src-js">  <span style="color: #00008b;">function</span>* fibonacci() {
      <span style="color: #00008b;">var</span> <span style="color: #b8860b;">pre</span> = 0, <span style="color: #b8860b;">cur</span> = 1;
      <span style="color: #00008b;">for</span> (;;) {
          <span style="color: #00008b;">var</span> <span style="color: #b8860b;">temp</span> = pre;
          pre = cur;
          cur += temp;
          <span style="color: #00008b;">yield</span> cur;
      }
  }
<span style="color: #00008b;">let</span> <span style="color: #b8860b;">fib</span> = fibonacci()
console.log(fib.next())
console.log(fib.next())
console.log(fib.next())
console.log(fib.next())
console.log(fib.next())
</pre>
</div>

<pre class="example">
{ value: 1, done: false }
{ value: 2, done: false }
{ value: 3, done: false }
{ value: 5, done: false }
{ value: 8, done: false }
</pre>
</div>
</div>
</div>
<div id="outline-container-orgheadline28" class="outline-2  slide">
<h2 id="orgheadline28"></h2>
<div class="outline-text-2" id="text-orgheadline28">
</div><div id="outline-container-orgheadline27" class="outline-3">
<h3 id="orgheadline27">但是promise只会把callback hell，改成 then hell</h3>
<div class="outline-text-3" id="text-orgheadline27">
<div class="org-src-container">

<pre class="src src-js"><span style="color: #00008b;">var</span> <span style="color: #b8860b;">asyncVal1</span> = Promise.resolve(1)
<span style="color: #00008b;">var</span> <span style="color: #b8860b;">asyncVal2</span> = Promise.resolve(2)
<span style="color: #00008b;">var</span> <span style="color: #b8860b;">asyncVal3</span> = Promise.resolve(3)
asyncVal1.then(val1=&gt;(
    asyncVal2.then(val2=&gt;(
        asyncVal3.then(val3=&gt;val1+val2+val3)
    ))
))
.then(log(<span style="color: #8b0000;">'sum of val 1 2 3'</span>))
</pre>
</div>
</div>
</div>
</div>
<div id="outline-container-orgheadline30" class="outline-2  slide">
<h2 id="orgheadline30"></h2>
<div class="outline-text-2" id="text-orgheadline30">
</div><div id="outline-container-orgheadline29" class="outline-3">
<h3 id="orgheadline29">虽然这种情况可以用 Promise.all 来解决</h3>
<div class="outline-text-3" id="text-orgheadline29">
<div class="org-src-container">

<pre class="src src-js">Promise.all([asyncVal1, asyncVal2, asyncVal3])
       .then(([val1,val2,val3])=&gt;val1+val2+val3)
</pre>
</div>
</div>
</div>
</div>
<div id="outline-container-orgheadline32" class="outline-2  slide">
<h2 id="orgheadline32"></h2>
<div class="outline-text-2" id="text-orgheadline32">
</div><div id="outline-container-orgheadline31" class="outline-3">
<h3 id="orgheadline31"></h3>
<div class="outline-text-3" id="text-orgheadline31">
<blockquote>
<p>
但是并不是所有then hell都可以用promise的combinator就能解决的, 而generator的支持，彻底让我们离开了 then hell
</p>
</blockquote>
</div>
</div>
</div>
<div id="outline-container-orgheadline34" class="outline-2  slide">
<h2 id="orgheadline34"></h2>
<div class="outline-text-2" id="text-orgheadline34">
</div><div id="outline-container-orgheadline33" class="outline-3">
<h3 id="orgheadline33">coroutine</h3>
<div class="outline-text-3" id="text-orgheadline33">
<p>
使用 <a href="http://taskjs.org/">task</a> 或者 <a href="https://github.com/cujojs/when/blob/master/docs/api.md#es6-generators">when</a> 你可以使用 generator 和 promise 来写 coroutine
</p>

<div class="org-src-container">

<pre class="src src-js">spawn(<span style="color: #00008b;">function</span>*(asyncVal1, asyncVal2, asyncVal3) {
    <span style="color: #00008b;">let</span> <span style="color: #b8860b;">val1</span> = <span style="color: #00008b;">yield</span> asyncVal1;
    <span style="color: #00008b;">let</span> <span style="color: #b8860b;">val2</span> = <span style="color: #00008b;">yield</span> asyncVal2;
    <span style="color: #00008b;">let</span> <span style="color: #b8860b;">val3</span> = <span style="color: #00008b;">yield</span> asyncVal3;
    <span style="color: #00008b;">return</span> val1 + val2 + val3
});
</pre>
</div>
</div>
</div>
</div>
<div id="outline-container-orgheadline36" class="outline-2  slide">
<h2 id="orgheadline36"></h2>
<div class="outline-text-2" id="text-orgheadline36">
</div><div id="outline-container-orgheadline35" class="outline-3">
<h3 id="orgheadline35">最重要的是，还可以命令式的 try catch</h3>
<div class="outline-text-3" id="text-orgheadline35">
<div class="org-src-container">

<pre class="src src-js">spawn(<span style="color: #00008b;">function</span>*(asyncVal1, asyncVal2, asyncVal3) {
    <span style="color: #00008b;">try</span> {
        <span style="color: #00008b;">let</span> <span style="color: #b8860b;">val1</span> = <span style="color: #00008b;">yield</span> asyncVal1;
        <span style="color: #00008b;">let</span> <span style="color: #b8860b;">val2</span> = <span style="color: #00008b;">yield</span> asyncVal2;
        <span style="color: #00008b;">let</span> <span style="color: #b8860b;">val3</span> = <span style="color: #00008b;">yield</span> asyncVal3;
        <span style="color: #00008b;">return</span> val1 + val2 + val3
    } <span style="color: #00008b;">catch</span>(e) {
        <span style="color: #00008b;">return</span> <span style="color: #6b8e23;">NaN</span>
    }
});
</pre>
</div>
</div>
</div>
</div>

<div id="outline-container-orgheadline38" class="outline-2  slide">
<h2 id="orgheadline38"></h2>
<div class="outline-text-2" id="text-orgheadline38">
</div><div id="outline-container-orgheadline37" class="outline-3">
<h3 id="orgheadline37">现在有了 async function，不再需要第三方库的支持</h3>
<div class="outline-text-3" id="text-orgheadline37">
<div class="org-src-container">

<pre class="src src-js">async <span style="color: #00008b;">function</span> asyncSum(<span style="color: #b8860b;">asyncVal1</span>, <span style="color: #b8860b;">asyncVal2</span>, <span style="color: #b8860b;">asyncVal3</span>) {
    <span style="color: #00008b;">let</span> <span style="color: #b8860b;">val1</span> = await asyncVal1;
    <span style="color: #00008b;">let</span> <span style="color: #b8860b;">val2</span> = await asyncVal2;
    <span style="color: #00008b;">let</span> <span style="color: #b8860b;">val3</span> = await asyncVal3;
    <span style="color: #00008b;">return</span> val1 + val2 + val3
};
</pre>
</div>
</div>
</div>
</div>

<div id="outline-container-orgheadline40" class="outline-2  slide">
<h2 id="orgheadline40"></h2>
<div class="outline-text-2" id="text-orgheadline40">
</div><div id="outline-container-orgheadline39" class="outline-3">
<h3 id="orgheadline39">但是不用太激动</h3>
<div class="outline-text-3" id="text-orgheadline39">
<p>
<a href="https://tc39.github.io/ecmascript-asyncawait/#desugaring">其实 async 只是 spawn 的语法糖</a>
</p>

<div class="org-src-container">

<pre class="src src-js">async <span style="color: #00008b;">function</span> &lt;name&gt;?&lt;argumentlist&gt;&lt;body&gt;

<span style="color: #8c8c8c; font-style: italic;">// </span><span style="color: #8c8c8c; font-style: italic;">=&gt;</span>

<span style="color: #00008b;">function</span> &lt;name&gt;?&lt;argumentlist&gt;{ <span style="color: #00008b;">return</span> spawn(<span style="color: #00008b;">function</span>*() &lt;body&gt;, <span style="color: #6b8e23;">this</span>); }
</pre>
</div>
</div>
</div>
</div>

<div id="outline-container-orgheadline42" class="outline-2  slide">
<h2 id="orgheadline42">而spawn的实现也很简单</h2>
<div class="outline-text-2" id="text-orgheadline42">
</div><div id="outline-container-orgheadline41" class="outline-3">
<h3 id="orgheadline41">返回一个 Promise</h3>
<div class="outline-text-3" id="text-orgheadline41">
<div class="org-src-container">

<pre class="src src-js"><span style="color: #00008b;">function</span> <span style="color: #6a5acd;">spawn</span>(<span style="color: #b8860b;">genF</span>, <span style="color: #b8860b;">self</span>) {
    <span style="color: #00008b;">return</span> <span style="color: #00008b;">new</span> <span style="color: #36648b;">Promise</span>(<span style="color: #00008b;">function</span>(<span style="color: #b8860b;">resolve</span>, <span style="color: #b8860b;">reject</span>) {
      ...
    });
}
</pre>
</div>
</div>
</div>
</div>

<div id="outline-container-orgheadline44" class="outline-2  slide">
<h2 id="orgheadline44"></h2>
<div class="outline-text-2" id="text-orgheadline44">
</div><div id="outline-container-orgheadline43" class="outline-3">
<h3 id="orgheadline43">call the generator function <code>genF</code></h3>
<div class="outline-text-3" id="text-orgheadline43">
<div class="org-src-container">

<pre class="src src-js"><span style="color: #00008b;">function</span> <span style="color: #6a5acd;">spawn</span>(<span style="color: #b8860b;">genF</span>, <span style="color: #b8860b;">self</span>) {
    <span style="color: #00008b;">return</span> <span style="color: #00008b;">new</span> <span style="color: #36648b;">Promise</span>(<span style="color: #00008b;">function</span>(<span style="color: #b8860b;">resolve</span>, <span style="color: #b8860b;">reject</span>) {
        <span style="color: #00008b;">var</span> <span style="color: #b8860b;">gen</span> = genF.callself; <span style="color: #8c8c8c; font-style: italic;">// </span><span style="color: #8c8c8c; font-style: italic;">&lt;--</span>
        ...
    });
}
</pre>
</div>
</div>
</div>
</div>
<div id="outline-container-orgheadline46" class="outline-2  slide">
<h2 id="orgheadline46"></h2>
<div class="outline-text-2" id="text-orgheadline46">
</div><div id="outline-container-orgheadline45" class="outline-3">
<h3 id="orgheadline45">异步的递归step</h3>
<div class="outline-text-3" id="text-orgheadline45">
<div class="org-src-container">

<pre class="src src-js"><span style="color: #00008b;">function</span> <span style="color: #6a5acd;">spawn</span>(<span style="color: #b8860b;">genF</span>, <span style="color: #b8860b;">self</span>) {
    <span style="color: #00008b;">return</span> <span style="color: #00008b;">new</span> <span style="color: #36648b;">Promise</span>(<span style="color: #00008b;">function</span>(<span style="color: #b8860b;">resolve</span>, <span style="color: #b8860b;">reject</span>) {
        <span style="color: #00008b;">var</span> <span style="color: #b8860b;">gen</span> = genF.call(self);
        <span style="color: #00008b;">function</span> <span style="color: #6a5acd;">step</span>(<span style="color: #b8860b;">nextF</span>) {
            next = nextF();  <span style="color: #8c8c8c; font-style: italic;">// </span><span style="color: #8c8c8c; font-style: italic;">&lt;-- 2</span>
            Promise.resolve(next.value).then(<span style="color: #00008b;">function</span>(<span style="color: #b8860b;">v</span>) {
                step(<span style="color: #00008b;">function</span>() { <span style="color: #00008b;">return</span> gen.next(v); }); <span style="color: #8c8c8c; font-style: italic;">// </span><span style="color: #8c8c8c; font-style: italic;">&lt;-- 3</span>
            });
        }
        step(<span style="color: #00008b;">function</span>() { <span style="color: #00008b;">return</span> gen.next(<span style="color: #6b8e23;">undefined</span>); }); <span style="color: #8c8c8c; font-style: italic;">// </span><span style="color: #8c8c8c; font-style: italic;">&lt;-- 1</span>
    });
}
</pre>
</div>
</div>
</div>
</div>

<div id="outline-container-orgheadline48" class="outline-2  slide">
<h2 id="orgheadline48"></h2>
<div class="outline-text-2" id="text-orgheadline48">
</div><div id="outline-container-orgheadline47" class="outline-3">
<h3 id="orgheadline47">resolve or reject promise</h3>
<div class="outline-text-3" id="text-orgheadline47">
<div class="org-src-container">

<pre class="src src-js"><span style="color: #00008b;">function</span> <span style="color: #6a5acd;">spawn</span>(<span style="color: #b8860b;">genF</span>, <span style="color: #b8860b;">self</span>) {
    <span style="color: #00008b;">return</span> <span style="color: #00008b;">new</span> <span style="color: #36648b;">Promise</span>(<span style="color: #00008b;">function</span>(<span style="color: #b8860b;">resolve</span>, <span style="color: #b8860b;">reject</span>) {
        <span style="color: #00008b;">var</span> <span style="color: #b8860b;">gen</span> = genF.call(self);
        <span style="color: #00008b;">function</span> <span style="color: #6a5acd;">step</span>(<span style="color: #b8860b;">nextF</span>) {
            <span style="color: #00008b;">var</span> <span style="color: #b8860b;">next</span>;
            <span style="color: #00008b;">try</span> {
                next = nextF();
            } <span style="color: #00008b;">catch</span>(e) {
                <span style="color: #8c8c8c; font-style: italic;">// </span><span style="color: #8c8c8c; font-style: italic;">finished with failure, reject the promise</span>
                reject(e);  <span style="color: #8c8c8c; font-style: italic;">// </span><span style="color: #8c8c8c; font-style: italic;">&lt;--</span>
                <span style="color: #00008b;">return</span>;
            }
            <span style="color: #00008b;">if</span>(next.done) {
                <span style="color: #8c8c8c; font-style: italic;">// </span><span style="color: #8c8c8c; font-style: italic;">finished with success, resolve the promise</span>
                resolve(next.value);  <span style="color: #8c8c8c; font-style: italic;">// </span><span style="color: #8c8c8c; font-style: italic;">&lt;--</span>
                <span style="color: #00008b;">return</span>;
            }
            <span style="color: #8c8c8c; font-style: italic;">// </span><span style="color: #8c8c8c; font-style: italic;">not finished, chain off the yielded promise and `step` again</span>
            Promise.resolve(next.value).then(<span style="color: #00008b;">function</span>(<span style="color: #b8860b;">v</span>) {
                step(<span style="color: #00008b;">function</span>() { <span style="color: #00008b;">return</span> gen.next(v); });
            }, <span style="color: #00008b;">function</span>(<span style="color: #b8860b;">e</span>) {
                step(<span style="color: #00008b;">function</span>() { <span style="color: #00008b;">return</span> gen.<span style="color: #00008b;">throw</span>(e); }); <span style="color: #8c8c8c; font-style: italic;">// </span><span style="color: #8c8c8c; font-style: italic;">&lt;--</span>
            });
        }
        step(<span style="color: #00008b;">function</span>() { <span style="color: #00008b;">return</span> gen.next(<span style="color: #6b8e23;">undefined</span>); });
    });
}
</pre>
</div>
</div>
</div>
</div>

<div id="outline-container-orgheadline49" class="outline-2  slide">
<h2 id="orgheadline49">Refs</h2>
<div class="outline-text-2" id="text-orgheadline49">
<ul class="org-ul">
<li><a href="https://github.com/tc39/proposals/blob/master/finished-proposals.md">https://github.com/tc39/proposals/blob/master/finished-proposals.md</a></li>
<li><a href="https://tc39.github.io/ecma262/">https://tc39.github.io/ecma262/</a></li>
<li><a href="https://tc39.github.io/ecmascript-asyncawait/">https://tc39.github.io/ecmascript-asyncawait/</a></li>
<li><a href="https://github.com/jcouyang/clojure-flavored-javascript/blob/master/book/zh/%E7%AC%AC%E5%85%AB%E7%AB%A0.org">https://github.com/jcouyang/clojure-flavored-javascript/blob/master/book/zh/%E7%AC%AC%E5%85%AB%E7%AB%A0.org</a></li>
<li><a href="https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/Object/getOwnPropertyDescriptors">https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/Object/getOwnPropertyDescriptors</a></li>
<li><a href="https://developer.mozilla.org/en-US/docs/Web/JavaScript/Guide/Working_with_Objects">https://developer.mozilla.org/en-US/docs/Web/JavaScript/Guide/Working_with_Objects</a></li>
<li><a href="https://developer.mozilla.org/en/docs/Web/JavaScript/Reference/Global_objects/Object/values">https://developer.mozilla.org/en/docs/Web/JavaScript/Reference/Global_objects/Object/values</a></li>
<li><a href="http://blog.oyanglul.us/javascript/essential-ecmascript6.html">http://blog.oyanglul.us/javascript/essential-ecmascript6.html</a></li>
<li><a href="http://kangax.github.io/compat-table/es6/">http://kangax.github.io/compat-table/es6/</a></li>
</ul>
</div>
</div>


<!-- Place the following snippet at the bottom of the deck container. -->
<p class="deck-status" aria-role="status">
  <span class="deck-status-current"></span>
  /
  <span class="deck-status-total"></span>
</p>

<!-- Place the following snippet at the bottom of the deck container. -->
<div aria-role="navigation">
  <a href="#" class="deck-prev-link" title="Previous">&#8592;</a>
  <a href="#" class="deck-next-link" title="Next">&#8594;</a>
</div>

<!-- Place the following snippet at the bottom of the deck container. -->
<form action="." method="get" class="goto-form">
  <label for="goto-slide">Go to slide:</label>
  <input type="text" name="slidenum" id="goto-slide" list="goto-datalist">
  <datalist id="goto-datalist"></datalist>
  <input type="submit" value="Go">
</form>
<div id="postamble" class="deck-status">
<p>Essential EcmaScript 2017 - <a href="https://oyanglul.us/">欧阳继超</a></p>
</div>

</div>
</body>
</html>
